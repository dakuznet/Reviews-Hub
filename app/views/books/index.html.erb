<div class="container mt-4">
  <!-- Заголовок и кнопка добавления -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Каталог книг</h1>
    <% if user_signed_in? %>
      <%= link_to "Добавить книгу", new_book_path, class: "btn btn-primary" %>
    <% end %>
  </div>

  <!-- Поиск и фильтры -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with(url: books_path, method: :get, class: "row g-3") do |f| %>
        <div class="col-md-8">
          <%= text_field_tag :search, params[:search], 
                class: "form-control", 
                placeholder: "Поиск по названию, автору или жанру..." %>
        </div>
        <div class="col-md-3">
          <%= select_tag :genre, 
                options_for_select([["Все жанры", ""]] + @genres.map { |g| [g, g] }, params[:genre]),
                class: "form-select" %>
        </div>
        <div class="col-md-1">
          <%= submit_tag "Найти", class: "btn btn-primary w-100" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Список книг -->
  <% if @books.any? %>
    <div class="row">
      <% @books.each do |book| %>
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            <% if book.url.present? %>
              <img src="<%= book.url %>" class="card-img-top" alt="<%= book.title %>" style="height: 200px; object-fit: cover;">
            <% else %>
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="bi bi-book text-secondary display-4"></i>
              </div>
            <% end %>
            <div class="card-body">
              <h5 class="card-title"><%= book.title %></h5>
              <h6 class="card-subtitle mb-2 text-muted"><%= book.author %></h6>
              
              <!-- Рейтинг -->
              <div class="mb-3">
                <div class="d-flex align-items-center mb-1">
                  <div class="rating">
                    <% (1..5).each do |star| %>
                      <% if star <= book.average_rating.round %>
                        <i class="bi bi-star-fill text-warning"></i>
                      <% elsif star - 0.5 <= book.average_rating %>
                        <i class="bi bi-star-half text-warning"></i>
                      <% else %>
                        <i class="bi bi-star text-secondary"></i>
                      <% end %>
                    <% end %>
                  </div>
                  <span class="ms-2"><strong><%= book.average_rating %></strong>/5</span>
                  <small class="text-muted ms-2">(<%= book.reviews_count %>)</small>
                </div>
              </div>
              
              <!-- Информация о книге -->
              <p class="card-text">
                <small class="text-muted">
                  <i class="bi bi-calendar"></i> <%= book.year %> г.
                  <% if book.genre.present? %>
                    <br><i class="bi bi-tag"></i> <%= book.genre %>
                  <% end %>
                  <% if book.publisher.present? %>
                    <br><i class="bi bi-building"></i> <%= book.publisher %>
                  <% end %>
                </small>
              </p>
              
              <!-- Действия -->
              <div class="d-flex justify-content-between align-items-center mt-3">
                <%= link_to "Подробнее", book_path(book), class: "btn btn-outline-primary btn-sm" %>
                <% if user_signed_in? && book.user == current_user %>
                  <div class="btn-group">
                    <%= link_to "Редактировать", edit_book_path(book), class: "btn btn-outline-secondary btn-sm" %>
                    <%= button_to "Удалить", book_path(book), 
                          method: :delete, 
                          data: { confirm: "Вы уверены?" }, 
                          class: "btn btn-outline-danger btn-sm" %>
                  </div>
                <% end %>
              </div>
            </div>
            <div class="card-footer text-muted">
              <small>Добавлено: <%= book.user.email %></small>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-5">
      <i class="bi bi-book display-1 text-muted mb-3"></i>
      <h4 class="mb-3">Книг пока нет</h4>
      <p class="text-muted mb-4">Будьте первым, кто добавит книгу в каталог!</p>
      <% if user_signed_in? %>
        <%= link_to "Добавить первую книгу", new_book_path, class: "btn btn-primary" %>
      <% else %>
        <%= link_to "Войдите, чтобы добавить книгу", new_user_session_path, class: "btn btn-outline-primary" %>
      <% end %>
    </div>
  <% end %>
</div>