<%= form_with(model: [@reviewable, @review], local: true) do |form| %>
  <% if @review.errors.any? %>
    <div id="error_explanation" class="alert alert-danger">
      <h4><%= pluralize(@review.errors.count, "error") %> запрещают сохранение этого отзыва:</h4>
      <ul>
        <% @review.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field mb-3">
    <%= form.label :rating, "Оценка", class: "form-label" %>
    <div class="rating-input">
      <% (1..5).each do |star| %>
        <label class="star-label">
          <%= form.radio_button :rating, star, class: "d-none" %>
          <i class="bi bi-star<%= star <= (@review.rating || 0) ? '-fill' : '' %> star-icon" 
             data-value="<%= star %>"></i>
        </label>
      <% end %>
    </div>
    <small class="text-muted">Выберите от 1 до 5 звезд</small>
  </div>

  <div class="field mb-3">
    <%= form.label :text, "Текст отзыва", class: "form-label" %>
    <%= form.text_area :text, class: "form-control", rows: 4, 
          placeholder: "Напишите ваш отзыв (минимум 10 символов)" %>
  </div>

  <div class="actions">
    <%= form.submit @review.persisted? ? "Обновить отзыв" : "Оставить отзыв", 
          class: "btn btn-primary" %>
    <%= link_to 'Отмена', polymorphic_path(@reviewable), class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star-icon');
    const ratingInput = document.querySelectorAll('input[name="review[rating]"]');
    
    stars.forEach(star => {
      star.addEventListener('click', function() {
        const value = parseInt(this.dataset.value);
        
        stars.forEach((s, index) => {
          if (index < value) {
            s.classList.remove('bi-star');
            s.classList.add('bi-star-fill');
          } else {
            s.classList.remove('bi-star-fill');
            s.classList.add('bi-star');
          }
        });
        
        ratingInput[value - 1].checked = true;
      });
      
      star.addEventListener('mouseover', function() {
        const value = parseInt(this.dataset.value);
        
        stars.forEach((s, index) => {
          if (index < value) {
            s.classList.add('text-warning');
          }
        });
      });
      
      star.addEventListener('mouseout', function() {
        stars.forEach(s => {
          s.classList.remove('text-warning');
        });
        
        const selectedRating = document.querySelector('input[name="review[rating]"]:checked');
        if (selectedRating) {
          const value = parseInt(selectedRating.value);
          stars.forEach((s, index) => {
            if (index < value) {
              s.classList.add('text-warning');
            }
          });
        }
      });
    });
  });
</script>

<style>
  .rating-input {
    display: flex;
    gap: 10px;
  }
  
  .star-label {
    cursor: pointer;
  }
  
  .star-icon {
    font-size: 32px;
    color: #dee2e6;
    transition: color 0.2s;
  }
  
  .star-icon:hover {
    color: #ffc107;
  }
  
  .bi-star-fill {
    color: #ffc107;
  }
</style>